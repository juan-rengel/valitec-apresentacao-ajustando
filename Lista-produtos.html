<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ â€” Lista de Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
  <!-- libs para export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.26/jspdf.plugin.autotable.min.js"></script>

  <style>
  /* Barra superior para troca de loja (nova) */
  #barraLoja { display:flex; gap:10px; align-items:center; margin-bottom:12px; padding:10px; background:rgba(255,255,255,0.02); border-radius:8px; }
  #selectLojaInline, #btnVoltarPainel { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }

  /* Mantive seu estilo adaptado para cards e botÃµes */
  .produto-card { display:flex; flex-direction:column; gap:6px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.03); backdrop-filter: blur(6px); }
  .produto-card img { width:70px; height:70px; object-fit:cover; border-radius:6px; }
  .botoes-container { display:grid; grid-template-columns: repeat(2,1fr); gap:6px; margin-top:6px; }
  .botoes-container button { padding:6px 8px; font-size:12px; border-radius:6px; border:none; cursor:pointer; }
  @media (max-width:480px) { .produto-card img{ width:55px; height:55px } .botoes-container button{ font-size:11px } }

  </style>
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <aside class="sidebar">
      <h1></h1>
      <nav>
        <a href="dashboard.html">Painel</a>
        <a href="produto.html">Cadastrar Produtos</a>
        <a href="#" class="active">Lista de Produtos</a>
        <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
        <a href="calendario.html">CalendÃ¡rio</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar UsuÃ¡rios</a>
        <a href="relatorios.html">RelatÃ³rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

    <main class="main fade-in">
      <!-- BARRA NOVA: mostra loja atual, seletor inline e voltar ao painel -->
      <div id="barraLoja">
        <strong>Loja atual: <span id="lojaAtualText">â€”</span></strong>
        <select id="selectLojaInline" aria-label="Selecionar loja"></select>
        <button id="btnVoltarPainel">Voltar ao Painel</button>
      </div>

      <h2 class="page-title">Lista de Produtos</h2>
      <input type="text" id="busca" class="input-busca" placeholder="ðŸ” Buscar por nome, setor, cÃ³digo...">

      <div class="export-container" style="display:flex;gap:8px;margin:12px 0;">
        <button id="exportTela" class="btnExport">ðŸ“„ Exportar Tela (PDF/Excel)</button>
        <button id="exportTudo" class="btnExport">ðŸ—‚ Exportar Tudo (PDF/Excel)</button>
      </div>

      <div id="listaProdutos" class="lista-produtos"></div>
    </main>
  </div>

<script type="module">
/* ================== IMPORTS ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, getDoc, doc,
  updateDoc, deleteDoc, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

/* ================== FIREBASE ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================== PARSING URL ================== */
const urlParams = new URLSearchParams(window.location.search);
const lojaURL = urlParams.get("loja"); // pode ser null

/* ================== VARIÃVEIS ================== */
const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];
const friendly = {
  loja_cd_cidade: "CD Cidade",
  loja_cidade: "Cidade Nova",
  loja_terranova: "Terra Nova",
  loja_manoa: "Manoa",
  loja_zumbi: "Zumbi",
  loja_oswaldo: "Oswaldo",
  loja_mosaico: "Mosaico"
};
let loja = null;
let cargo = null;
let produtosCarregados = [];

/* ================== UI ELEMENTS ================== */
const selectInline = document.getElementById("selectLojaInline");
const lojaAtualText = document.getElementById("lojaAtualText");
const btnVoltarPainel = document.getElementById("btnVoltarPainel");

/* montar select inline (sempre) */
lojasValidas.forEach(l=>{
  const o = document.createElement("option");
  o.value = l;
  o.textContent = friendly[l] || l;
  selectInline.appendChild(o);
});

/* voltar para painel */
btnVoltarPainel.onclick = ()=> window.location.href = "painel-rebaixa.html";

/* trocar loja inline */
selectInline.onchange = ()=>{
  const nova = selectInline.value;
  localStorage.setItem("lastSelectedLoja", nova);
  // recarregar a pÃ¡gina com o param
  window.location.href = `Lista-produtos.html?loja=${encodeURIComponent(nova)}`;
};

/* ================== UTIL HELPERS ================== */
async function getConfigDaLoja(lojaOverride) {
  try {
    const lojaToUse = lojaOverride || loja;
    if (!lojaToUse) return null;
    const snapCfg = await getDoc(doc(db, `lojas/${lojaToUse}/config/geral`));
    if (!snapCfg.exists()) return { loja: lojaToUse, whatsGerente: "", whatsResponsavel: "" };
    const cfg = snapCfg.data();
    return { loja: lojaToUse, whatsGerente: cfg.whatsGerente || "", whatsResponsavel: cfg.whatsResponsavel || "" };
  } catch (e) {
    console.error("getConfigDaLoja erro:", e);
    return null;
  }
}

function abrirWhatsAppParaNumero(numero, texto) {
  if (!numero) return;
  const only = numero.replace(/\D/g, "");
  const url = `https://wa.me/55${only}?text=${encodeURIComponent(texto)}`;
  window.open(url, "_blank");
}

/* ================== REBAIXAR / REVERTER ================== */
async function rebaixarProduto(id) {
  try {
    const cfg = await getConfigDaLoja(loja);
    if (!cfg || !cfg.loja) return alert("Loja nÃ£o identificada.");

    const prodRef = doc(db, `lojas/${cfg.loja}/produtos/${id}`);
    const prodSnap = await getDoc(prodRef);
    if (!prodSnap.exists()) return alert("Produto nÃ£o encontrado.");

    const p = prodSnap.data();
    if (p.status === "rebaixado") return alert("Produto jÃ¡ estÃ¡ rebaixado.");

    await updateDoc(prodRef, {
      status: "rebaixado",
      rebaixadoAt: serverTimestamp(),
      rebaixadoNotified: true,
      lastAlertAt: serverTimestamp()
    });

    const texto = `ðŸ”» PRODUTO REBAIXADO\nProduto: ${p.nome}\nCÃ³digo: ${p.codigo}\nLote: ${p.lote}\nResponsÃ¡vel: ${localStorage.getItem("usuarioLogado") || "responsavel"}`;
    abrirWhatsAppParaNumero(cfg.whatsGerente, texto);

    await carregarProdutos();
  } catch (err) {
    console.error("Erro rebaixarProduto:", err);
    alert("Erro ao rebaixar produto. Veja console.");
  }
}
window.rebaixarProduto = rebaixarProduto;

async function reverterRebaixado(id) {
  try {
    const cfg = await getConfigDaLoja(loja);
    if (!cfg || !cfg.loja) return alert("Loja nÃ£o identificada.");

    const prodRef = doc(db, `lojas/${cfg.loja}/produtos/${id}`);
    const prodSnap = await getDoc(prodRef);
    if (!prodSnap.exists()) return alert("Produto nÃ£o encontrado.");

    const p = prodSnap.data();
    if (p.status !== "rebaixado") return alert("Produto nÃ£o estÃ¡ rebaixado.");

    await updateDoc(prodRef, {
      status: "normal",
      rebaixadoNotified: false,
      revertidoAt: serverTimestamp(),
      revertidoNotified: true,
      lastAlertAt: serverTimestamp()
    });

    const texto = `âœ… REVERTIDO\nProduto: ${p.nome}\nCÃ³digo: ${p.codigo}\nLote: ${p.lote}`;
    abrirWhatsAppParaNumero(cfg.whatsGerente, texto);

    await carregarProdutos();
  } catch (err) {
    console.error("Erro reverterRebaixado:", err);
    alert("Erro ao reverter. Veja console.");
  }
}
window.reverterRebaixado = reverterRebaixado;

/* ================== VERIFICAR ALERTAS ================== */
async function verificarAlertasDeValidade() {
  try {
    const cfg = await getConfigDaLoja(loja);
    if (!cfg || !cfg.loja) return;

    const ref = collection(db, `lojas/${cfg.loja}/produtos`);
    const snap = await getDocs(ref);

    for (const docSnap of snap.docs) {
      const p = docSnap.data();
      const id = docSnap.id;
      if (!p.dataValidadeISO) continue;
      if (p.status === "rebaixado") continue;

      const validade = new Date(p.dataValidadeISO);
      const hoje = new Date();
      // calcula dias restantes sem mutar objetos
      const diffMs = (new Date(validade.getFullYear(),validade.getMonth(),validade.getDate())) - (new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()));
      const dias = Math.ceil(diffMs / (1000*60*60*24));

      let alertaCor = "normal";
      if (dias <= 15 && dias > 10) alertaCor = "amarelo";
      else if (dias <= 10 && dias > 5) alertaCor = "laranja";
      else if (dias <= 5 && dias >= 0) alertaCor = "vermelho";
      else if (dias < 0) alertaCor = "vencido";

      if (p.alertaCor !== alertaCor) {
        try { await updateDoc(doc(db, `lojas/${cfg.loja}/produtos/${id}`), { alertaCor }); } catch(e){ console.error(e); }
      }

      if (dias === 5 && !p.alert5diasSent) {
        const texto = `âš ï¸ ALERTA DE VALIDADE\nProduto: ${p.nome}\nCÃ³digo: ${p.codigo}\nLote: ${p.lote}\nVence em ${dias} dias`;
        abrirWhatsAppParaNumero(cfg.whatsGerente, texto);
        try { await updateDoc(doc(db, `lojas/${cfg.loja}/produtos/${id}`), { alert5diasSent: true, lastAlertAt: serverTimestamp() }); } catch(e){ console.error(e); }
      }
    }
  } catch (err) {
    console.error("Erro verificarAlertasDeValidade:", err);
  }
}

/* ================== CARREGAR E EXIBIR ================== */
async function carregarProdutos() {
  try {
    const user = auth.currentUser;
    if (!user) return; // onAuthStateChanged trata redirecionamento

    // buscar perfil do usuÃ¡rio
    const userSnap = await getDoc(doc(db, "usuarios", user.email));
    if (!userSnap.exists()) {
      document.getElementById("listaProdutos").innerHTML = "<div class='produto-card'>UsuÃ¡rio sem perfil.</div>";
      return;
    }

    const lojaUsuario = userSnap.data().loja;
    cargo = userSnap.data().cargo || "gerente";

    // ðŸ“Œ 1 â€” BLOQUEIO DE ACESSO
    if (cargo !== "responsavel" && cargo !== "gerente" && cargo !== "master") {
      alert("âŒ VocÃª nÃ£o tem permissÃ£o para acessar esta pÃ¡gina.");
      return location.href = "dashboard.html";
    }

    // ðŸ“Œ 2 â€” DEFINIR LOJA
    if (cargo === "responsavel") {
      // ResponsÃ¡vel pode trocar de loja (via URL ou lastSelectedLoja)
      loja = lojasValidas.includes(lojaURL) ? lojaURL : (localStorage.getItem("lastSelectedLoja") || lojaUsuario);
    } else {
      // Gerente / master â€” sempre a loja fixa dele
      loja = lojaUsuario;

      if (lojaURL && lojaURL !== lojaUsuario) {
        console.warn("URL ignorada para gerente/master.");
      }

      // Ocultar UI de troca de loja para quem nÃ£o Ã© responsÃ¡vel
      const sel = document.getElementById("selectLojaInline");
      const btn = document.getElementById("btnVoltarPainel");
      if (sel) sel.style.display = "none";
      if (btn) btn.style.display = "none";
    }

    // ðŸ“Œ 3 â€” Atualizar a UI
    lojaAtualText.textContent = friendly[loja] || loja;
    selectInline.value = loja;

    // Query: carregar apenas produtos nÃ£o rebaixados (melhora performance)
    const q = query(collection(db, `lojas/${loja}/produtos`), where("status", "==", "normal"));
    const snap = await getDocs(q);

    produtosCarregados = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    exibirLista(produtosCarregados);
  } catch (err) {
    console.error("Erro carregarProdutos:", err);
    document.getElementById("listaProdutos").innerHTML = "<div class='produto-card'>Erro ao carregar produtos. Veja console.</div>";
  }
}

function exibirLista(listaProdutos) {
  const lista = document.getElementById("listaProdutos");
  lista.innerHTML = "";

  if (!Array.isArray(listaProdutos) || listaProdutos.length === 0) {
    lista.innerHTML = "<div class='produto-card'>Nenhum produto encontrado.</div>";
    return;
  }

  listaProdutos.forEach(p => {
    const item = document.createElement("div");
    item.className = "produto-card";

    const diff = p.dataValidadeISO ? Math.ceil((new Date(p.dataValidadeISO) - new Date()) / 86400000) : 0;
    const cor = diff <= 5 ? "#ff4d4d" :
                diff <= 10 ? "#ff9f43" :
                diff <= 15 ? "#ffe66d" : "#4eff9a";

    item.innerHTML = `
      <img src="${p.fotoURL || ""}" style="width:70px;height:70px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'">
      <div style="flex:1;">
        <strong>${p.nome || "â€”"}</strong><br>
        ${p.setor || ""}<br>
        <span style="color:#4eff9a">ðŸ’² R$ ${(Number(p.preco) || 0).toFixed(2).replace('.', ',')}</span><br>
        Validade: ${p.dataValidadeBR || ""}<br><span style="color:#ffd166">ðŸ“¦ Quantidade: ${p.quantidade ?? 0}</span>
      </div>
    `;

    const botoes = document.createElement("div");
    botoes.className = "botoes-container";

    // WHATSAPP: tenta responsavel, se nÃ£o existir usa gerente
    const btnWhats = document.createElement("button");
    btnWhats.textContent = "ðŸŸ¢ WhatsApp";
    btnWhats.style.background = "#25D366";
    btnWhats.onclick = async () => {
      try {
        const cfg = await getConfigDaLoja(loja);
        const numero = cfg.whatsResponsavel || cfg.whatsGerente || "";
        if (!numero) return alert("NÃºmero do responsÃ¡vel/gerente nÃ£o configurado.");
        const msg = `âš ï¸ Rebaixa solicitada\nProduto: ${p.nome || ""}\nValidade: ${p.dataValidadeBR || ""}`;
        abrirWhatsAppParaNumero(numero, msg);
      } catch (e) { console.error(e); alert("Erro ao buscar contato."); }
    };
    botoes.appendChild(btnWhats);

    // REBAIXAR
    const btnRebaixar = document.createElement("button");
    btnRebaixar.style.background = cor;
    btnRebaixar.textContent = `ðŸ”» Rebaixar (${diff}d)`;
    btnRebaixar.onclick = () => rebaixarProduto(p.id);
    botoes.appendChild(btnRebaixar);

    // EDITAR / EXCLUIR: somente se NÃƒO for responsÃ¡vel
    if (cargo !== "responsavel") {
      const btnEditar = document.createElement("button");
      btnEditar.textContent = "âœï¸ Editar";
      btnEditar.style.background = "#4d9cff";
      btnEditar.onclick = () => location.href = `produto.html?id=${encodeURIComponent(p.id)}&loja=${encodeURIComponent(loja)}`;
      botoes.appendChild(btnEditar);

      const btnExcluir = document.createElement("button");
      btnExcluir.textContent = "ðŸ—‘ï¸ Excluir";
      btnExcluir.style.background = "#ff6b6b";
      btnExcluir.onclick = async () => {
        if (!confirm(`Excluir ${p.nome || "produto"}?`)) return;
        try {
          await deleteDoc(doc(db, `lojas/${loja}/produtos/${p.id}`));
          await carregarProdutos();
        } catch (e) { console.error(e); alert("Erro ao excluir."); }
      };
      botoes.appendChild(btnExcluir);
    }

    item.appendChild(botoes);
    lista.appendChild(item);
  });
}

/* ================== FILTRO BUSCA ================== */
document.getElementById("busca").addEventListener("input", e => {
  const termo = e.target.value.toLowerCase();
  const filtrados = produtosCarregados.filter(p =>
    (p.nome || "").toLowerCase().includes(termo) ||
    (p.setor || "").toLowerCase().includes(termo) ||
    (p.codigo || "").toLowerCase().includes(termo)
  );
  exibirLista(filtrados);
});

/* ================== EXPORTAÃ‡ÃƒO ================== */
function produtosParaLinhas(arr) {
  return arr.map(p => ({
    Nome: p.nome || "",
    Codigo: p.codigo || "",
    Lote: p.lote || "",
    Setor: p.setor || "",
    Preco: (Number(p.preco) || 0).toFixed(2).replace('.', ','),
    Quantidade: p.quantidade ?? 0,
    Validade: p.dataValidadeBR || "",
    Status: p.status || "normal"
  }));
}

async function exportToXLSX(rows, filename = "produtos.xlsx") {
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Produtos");
  XLSX.writeFile(wb, filename);
}
async function exportToPDF(rows, filename = "produtos.pdf") {
  try {
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF('p', 'pt', 'a4');
    const columns = Object.keys(rows[0] || {}).map(k => ({ header: k, dataKey: k }));
    docPDF.autoTable({
      head: [columns.map(c => c.header)],
      body: rows.map(r => Object.values(r)),
      startY: 40,
      styles: { fontSize: 9 },
      headStyles: { fillColor: [0,200,255], textColor: 0 }
    });
    docPDF.save(filename);
  } catch (e) {
    console.error("Erro gerar PDF:", e);
    alert("Erro ao gerar PDF. Veja console.");
  }
}

document.getElementById("exportTela").onclick = async () => {
  try {
    const termo = document.getElementById("busca").value.toLowerCase();
    const visiveis = produtosCarregados.filter(p =>
      (p.nome || "").toLowerCase().includes(termo) ||
      (p.setor || "").toLowerCase().includes(termo) ||
      (p.codigo || "").toLowerCase().includes(termo)
    );
    if (visiveis.length === 0) return alert("Nenhum produto visÃ­vel para exportar.");
    const linhas = produtosParaLinhas(visiveis);
    await exportToXLSX(linhas, `produtos_tela_${new Date().toISOString().slice(0,10)}.xlsx`);
    await exportToPDF(linhas, `produtos_tela_${new Date().toISOString().slice(0,10)}.pdf`);
  } catch (e) { console.error(e); alert("Erro ao exportar. Veja console."); }
};

document.getElementById("exportTudo").onclick = async () => {
  try {
    const cfg = await getConfigDaLoja(loja);
    if (!cfg || !cfg.loja) return alert("Loja nÃ£o identificada.");
    const snap = await getDocs(collection(db, `lojas/${cfg.loja}/produtos`));
    const todos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (todos.length === 0) return alert("Nenhum produto encontrado na loja.");
    const linhas = produtosParaLinhas(todos);
    await exportToXLSX(linhas, `produtos_tudo_${cfg.loja}_${new Date().toISOString().slice(0,10)}.xlsx`);
    await exportToPDF(linhas, `produtos_tudo_${cfg.loja}_${new Date().toISOString().slice(0,10)}.pdf`);
  } catch (e) { console.error("Erro exportTudo:", e); alert("Erro ao exportar tudo. Veja console."); }
};

/* ================== INIT / AUTH ================== */
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "index.html";
  carregarProdutos().catch(console.error);
  setTimeout(() => verificarAlertasDeValidade().catch(console.error), 1500);
});

/* ================== export para console (debug helpers) ================== */
window._debug_lista = {
  getCurrentLoja: () => loja,
  getCargo: () => cargo,
  getProdutosLoaded: () => produtosCarregados
};
</script>

<script>
/* hamburger (mantive seu cÃ³digo) */
const sidebar = document.querySelector('.sidebar');
let hamburgerBtn = document.querySelector('.hamburger');
if (!hamburgerBtn) { hamburgerBtn = document.createElement('button'); hamburgerBtn.className = 'hamburger'; hamburgerBtn.textContent = 'â˜°'; document.body.appendChild(hamburgerBtn); }
hamburgerBtn.onclick = () => { sidebar.classList.toggle('open'); };
</script>

</body>
</html>
