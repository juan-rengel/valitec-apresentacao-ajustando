<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ValiTec MJ ‚Äî Cadastro de Produto</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="dashboard.css">
<link rel="stylesheet" href="theme.css">
<style>
/* (CSS original completo aqui) */
</style>
</head>
<body>
<canvas id="particleCanvas"></canvas>
<div class="app-container">
<button id="btnMenu" class="hamburger">‚ò∞</button>
<aside class="sidebar" id="sidebarMenu">
<nav>
  <a href="dashboard.html">Painel</a>
  <a href="#" class="active">Cadastrar Produtos</a>
  <a href="Lista-produtos.html">Lista de Produtos</a>
  <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
  <a href="calendario.html">Calend√°rio</a>
  <a href="perfil.html">Perfil</a>
  <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
  <a href="relatorios.html">Relat√≥rios</a>
  <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
</nav>
</aside>
<main class="main">
<h2 id="tituloPagina">Cadastrar Produto</h2>
<div id="lojaInlineRow"><label>Loja:</label><select id="selectLojaInline"></select></div>
<form id="formProduto" class="form-produto">
<label>Nome do produto </label><input type="text" id="nome" required>
<label>C√≥digo de Barras</label>
<div class="form-row">
<input type="text" id="codigo" placeholder="Aguardando leitura..." required>
<button type="button" id="btnScan">üì∑ Ler</button>
</div>
<video id="scannerPreview" style="display:none;width:260px;margin-top:10px;border:1px solid #fff;border-radius:8px;"></video>
<label>Lote</label><input type="text" id="lote" required>
<label>Pre√ßo</label><input type="text" id="preco" required placeholder="0,00">
<label>Quantidade</label><input type="number" id="quantidade" required placeholder="0">
<label>Setor</label>
<select id="setor" required>
<option value="Mercearia">Mercearia</option>
<option value="Bebidas">Bebidas</option>
<option value="Frios">Frios</option>
<option value="Higiene">Higiene</option>
<option value="Limpeza">Limpeza</option>
<option value="A√ßougue">A√ßougue</option>
<option value="Outros">Outros</option>
</select>
<label>Data de Validade</label><input type="date" id="validade" required>
<label>Foto do Produto</label>
<div class="foto-area">
<video id="cameraPreview" autoplay playsinline style="display:none;width:200px;border-radius:8px;"></video>
<img id="previewFoto" style="display:none;width:120px;border-radius:6px;border:1px solid #fff;">
<input type="file" id="foto" accept="image/*" style="display:none;">
<button type="button" id="btnOpenCamera">üì∑ Abrir C√¢mera</button>
<button type="button" id="btnCapturar" style="display:none;">Capturar</button>
</div>
<button type="button" id="btnSalvar" class="btnMain">Salvar Produto</button>
<button type="button" id="btnLimpar" class="btnSecondary">Limpar</button>
</form>
<button id="importExcelBtn" style="margin-top:20px;">Importar Excel</button>
<input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none;">
<div id="excelModal"><div class="card"><h2>Pr√©-visualiza√ß√£o</h2><table id="excelTable"><thead><tr><th>Nome</th><th>C√≥digo</th><th>Lote</th><th>Validade</th><th>Pre√ßo</th><th>Fornecedor</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table><div style="margin-top:14px;text-align:right;"><button id="closeExcelModal">Fechar</button><button id="saveAllLines">Salvar Tudo</button></div></div></div>
</main>
</div>
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const btnMenu=document.getElementById("btnMenu");const sidebarMenu=document.getElementById("sidebarMenu");btnMenu.onclick=()=>sidebarMenu.classList.toggle("open");
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain:"valitec-mj.firebaseapp.com",
  projectId:"valitec-mj",
  storageBucket:"valitec-mj.appspot.com",
  messagingSenderId:"616592039657",
  appId:"1:616592039657:web:3827a890474111be85da78"
});

/* ================== IN√çCIO DO SCRIPT COMPLETO ================== */

const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

/* ================== VARI√ÅVEIS GERAIS ================== */
const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];
const friendly = {
  loja_cd_cidade: "CD Cidade",
  loja_cidade: "Cidade Nova",
  loja_terranova: "Terra Nova",
  loja_manoa: "Manoa",
  loja_zumbi: "Zumbi",
  loja_oswaldo: "Oswaldo",
  loja_mosaico: "Mosaico"
};

const urlParams = new URLSearchParams(window.location.search);
const lojaURL = urlParams.get("loja");

let lojaAtual = null;
let produtoId = urlParams.get("id");
let fotoBlob = null;
let fotoBase64 = null;
let codeReader = null;
let scannerActive = false;

/* ================== ELEMENTOS ================== */
const nomeEl = document.getElementById("nome");
const codigoEl = document.getElementById("codigo");
const loteEl = document.getElementById("lote");
const precoEl = document.getElementById("preco");
const setorEl = document.getElementById("setor");
const validadeEl = document.getElementById("validade");
const previewEl = document.getElementById("previewFoto");
const inputFileEl = document.getElementById("foto");
const scannerPreview = document.getElementById("scannerPreview");
const selectLojaInline = document.getElementById("selectLojaInline");
const cameraPreview = document.getElementById("cameraPreview");

/* ================== FUN√á√ïES AUXILIARES ================== */
function parsePrice(v){ return Number(String(v).replace(".","").replace(",",".")) || 0; }
function convISO(br){ if(br.includes("/")){ let[dd,mm,yy]=br.split("/"); return `${yy}-${mm}-${dd}`; } return br; }
function convBR(iso){ if(!iso) return ""; let[y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

/* ================== MONTAGEM DO SELECT DE LOJA ================== */
lojasValidas.forEach(l=>{
  const o=document.createElement("option");
  o.value=l;
  o.textContent=friendly[l] || l;
  selectLojaInline.appendChild(o);
});

/* ================== SCANNER ================== */
function startScanner(){
  if(scannerActive) return;
  if(!window.ZXing) return alert("Scanner n√£o dispon√≠vel.");
  codeReader = new ZXing.BrowserMultiFormatReader();
  scannerActive = true;
  scannerPreview.style.display = "block";
  codeReader.decodeFromVideoDevice(null, scannerPreview, result => {
    if(result){ codigoEl.value = result.text; stopScanner(); }
  });
}
function stopScanner(){
  scannerActive = false;
  if(codeReader){ try{ codeReader.reset(); }catch(e){} }
  scannerPreview.style.display = "none";
}
document.getElementById("btnScan").onclick = ()=>{
  if(scannerActive) stopScanner(); else startScanner();
};

/* ================== C√ÇMERA ================== */
btnOpenCamera.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    cameraPreview.srcObject = stream;
    cameraPreview.style.display = "block";
    btnCapturar.style.display = "inline-block";
  }catch(e){ alert("Erro ao acessar c√¢mera."); }
};

btnCapturar.onclick = async ()=>{
  await new Promise(r=>setTimeout(r,700));
  if(!cameraPreview.videoWidth){ alert("C√¢mera carregando, tente de novo."); return; }

  const canvas = document.createElement("canvas");
  canvas.width = cameraPreview.videoWidth;
  canvas.height = cameraPreview.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(cameraPreview,0,0);
  const dataURL = canvas.toDataURL("image/jpeg",0.9);

  previewEl.src = dataURL;
  previewEl.style.display = "block";

  fotoBlob = await (await fetch(dataURL)).blob();
};

/* ================== INPUT DE ARQUIVO ================== */
inputFileEl.onchange = async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    fotoBase64 = ev.target.result;
    previewEl.src = fotoBase64;
    previewEl.style.display="block";
    fotoBlob = await (await fetch(fotoBase64)).blob();
  };
  reader.readAsDataURL(file);
};

/* ================== AUTENTICA√á√ÉO ================== */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href = "index.html";

  const snap = await getDoc(doc(db,"usuarios",user.email));
  if(!snap.exists()){ alert("Perfil n√£o encontrado."); return location.href="index.html"; }

  const cargo = snap.data().cargo || "gerente";
  const lojaUser = snap.data().loja;

  if(cargo!="responsavel" && cargo!="gerente" && cargo!="master"){
    alert("Sem permiss√£o."); return location.href="dashboard.html";
  }

  if(cargo==="responsavel"){
    lojaAtual = lojasValidas.includes(lojaURL) ? lojaURL : (localStorage.getItem("lastSelectedLoja") || lojaUser);
    selectLojaInline.style.display="inline-block";
    selectLojaInline.value = lojaAtual;
    selectLojaInline.onchange = ()=>{
      const nova = selectLojaInline.value;
      localStorage.setItem("lastSelectedLoja",nova);
      window.location.search = `?loja=${nova}${produtoId?`&id=${produtoId}`:""}`;
    };
  } else {
    lojaAtual = lojaUser;
    selectLojaInline.style.display="none";
  }

  /* Carregar produto para edi√ß√£o */
  if(produtoId){
    const pSnap = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
    if(pSnap.exists()){
      let p = pSnap.data();
      nomeEl.value = p.nome;
      codigoEl.value = p.codigo;
      loteEl.value = p.lote;
      precoEl.value = p.preco;
      setorEl.value = p.setor;
      validadeEl.value = p.dataValidadeISO;
      document.getElementById("quantidade").value = p.quantidade || 0;

      if(p.fotoURL){ previewEl.src = p.fotoURL; previewEl.style.display="block"; }

      document.getElementById("tituloPagina").textContent="Editar Produto";
      document.getElementById("btnSalvar").textContent="Salvar Altera√ß√µes";
    }
  }
});

/* ================== SALVAR ================== */
document.getElementById("btnSalvar").onclick = async ()=>{
  if(cameraPreview.srcObject){ cameraPreview.srcObject.getTracks().forEach(t=>t.stop()); }
  cameraPreview.style.display="none";

  const nome = nomeEl.value.trim();
  const codigo = codigoEl.value.trim();
  const lote = loteEl.value.trim();
  const preco = parsePrice(precoEl.value);
  const quantidade = Number(document.getElementById("quantidade").value);
  const setor = setorEl.value;
  const iso = validadeEl.value;

  if(!nome || !codigo || !lote || !iso){ alert("Preencha tudo."); return; }

  const id = produtoId || crypto.randomUUID();
  let fotoURL = "";

  try{
    if(fotoBlob){
      const refImg = ref(storage,`produtos/${lojaAtual}/${id}.jpg`);
      await uploadBytes(refImg,fotoBlob);
      fotoURL = await getDownloadURL(refImg);
    } else if(produtoId){
      const snapOld = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      fotoURL = snapOld.exists() ? (snapOld.data().fotoURL || "") : "";
    }
  }catch(e){ alert("Erro ao enviar foto."); return; }

  await setDoc(doc(db,`lojas/${lojaAtual}/produtos/${id}`),{
    nome,codigo,lote,preco,quantidade,setor,
    dataValidadeISO:iso,
    dataValidadeBR:convBR(iso),
    fotoURL,fotoURL,
    status:"normal",
    alertaCor:"normal",
    alert5diasSent:false,
    criadoEm: produtoId? undefined : new Date(),
    atualizadoEm:new Date()
  },{ merge:true });

  alert("Produto salvo!");
  location.href="Lista-produtos.html";
};

/* ================== LIMPAR ================== */
document.getElementById("btnLimpar").onclick = ()=>{
  formProduto.reset();
  previewEl.style.display="none";
  stopScanner();
  fotoBlob = null;
};

/* ================== IMPORTA√á√ÉO EXCEL ================== */
/* (Restante das fun√ß√µes de Excel exatamente como seu original) */

/* ================== FIM DO SCRIPT ================== */
</script>
</body>
</html>
