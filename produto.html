<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ValiTec MJ ‚Äî Cadastro de produtos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="dashboard.css">
<link rel="stylesheet" href="theme.css">
<style>
/* ----- Estilos m√≠nimos para o formul√°rio ----- */
body { font-family: 'Poppins', sans-serif; background: #071021; color: #e6eef8; margin:0 }
.app-container { display:flex; min-height:100vh }
.sidebar { width:240px; background: #061226; padding:18px; box-shadow: 0 0 30px rgba(0,0,0,0.6) }
.main { flex:1; padding:22px; }
.form-produto { max-width:820px; margin:0 auto; display:flex; flex-direction:column; gap:10px }
label{font-weight:600}
.input, input, select, button { font-family:inherit }
input[type=text], input[type=date], input[type=number], select { padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit }
button { padding:10px 12px; border-radius:8px; border:none; cursor:pointer }
.btnMain { background:#00c8ff; color:#05202a }
.btnSecondary { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06) }
.foto-area { display:flex; gap:10px; align-items:center }
#previewFoto{ width:120px; height:90px; object-fit:cover; border-radius:6px; display:none }
#cameraPreview{ width:200px; height:140px; border-radius:8px; display:none }
#scannerPreview{ width:260px; height:200px; display:none }
.hamburger{ display:none }
@media(max-width:900px){ .hamburger{ display:block } .sidebar{ position:fixed; left:-260px; top:0; height:100vh } .sidebar.open{ left:0 } }
#excelModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9999 }
#excelModal .card{ background:#071322; padding:16px; border-radius:10px; width:95%; max-width:980px }
</style>
</head>
<body>
<canvas id="particleCanvas"></canvas>
<div class="app-container">
  <button id="btnMenu" class="hamburger">‚ò∞</button>
  <aside class="sidebar" id="sidebarMenu">
    <nav>
      <a href="dashboard.html">Painel</a>
      <a href="#" class="active">Cadastrar Produtos</a>
      <a href="Lista-produtos.html">Lista de Produtos</a>
      <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
      <a href="calendario.html">Calend√°rio</a>
      <a href="perfil.html">Perfil</a>
      <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
      <a href="relatorios.html">Relat√≥rios</a>
      <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
    </nav>
  </aside>
  <main class="main">
    <h2 id="tituloPaginaTexto">Cadastrar </h2>
    <div id="lojaInlineRow"><label>Loja:</label><select id="selectLojaInline"></select></div>

    <form id="formProduto" class="form-produto" onsubmit="return false;">
      <label>Nome do produto</label>
      <input type="text" id="nome" required>

      <label>C√≥digo de Barras</label>
      <div class="form-row" style="display:flex;gap:8px;align-items:center">
        <input type="text" id="codigo" placeholder="Aguardando leitura..." required style="flex:1">
        <button type="button" id="btnScan">üì∑ Ler</button>
      </div>
      <video id="scannerPreview" ></video>

      <label>Lote</label>
      <input type="text" id="lote" required>

      <label>Pre√ßo</label>
      <input type="text" id="preco" required placeholder="0,00">

      <label>Quantidade</label>
      <input type="number" id="quantidade" required placeholder="0">

      <label>Setor</label>
      <select id="setor" required>
        <option value="Mercearia">Mercearia</option>
        <option value="Bebidas">Bebidas</option>
        <option value="Frios">Frios</option>
        <option value="Higiene">Higiene</option>
        <option value="Limpeza">Limpeza</option>
        <option value="A√ßougue">A√ßougue</option>
        <option value="Outros">Outros</option>
      </select>

      <label>Data de Validade</label>
      <input type="date" id="validade" required>

      <label>Foto do Produto</label>
      <div class="foto-area">
        <video id="cameraPreview" autoplay playsinline></video>
        <img id="previewFoto" alt="preview">
        <input type="file" id="foto" accept="image/*" style="display:none">
        <div style="display:flex;flex-direction:column;gap:6px">
          <button type="button" id="btnOpenCamera">üì∑ Abrir C√¢mera</button>
          <button type="button" id="btnCapturar" style="display:none">Capturar</button>
          <button type="button" id="btnOpenFile">üìÅ Escolher</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:6px">
        <button type="button" id="btnSalvar" class="btnMain">Salvar Produto</button>
        <button type="button" id="btnLimpar" class="btnSecondary">Limpar</button>
      </div>
    </form>

    <div style="margin-top:18px">
      <button id="importExcelBtn">Importar Excel</button>
      <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none">
    </div>

    <div id="excelModal"><div class="card"><h3>Pr√©-visualiza√ß√£o</h3><table id="excelTable" style="width:100%;border-collapse:collapse"><thead><tr><th>Nome</th><th>C√≥digo</th><th>Lote</th><th>Validade</th><th>Pre√ßo</th><th>Fornecedor</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table><div style="text-align:right;margin-top:10px"><button id="closeExcelModal">Fechar</button><button id="saveAllLines">Salvar Tudo</button></div></div></div>

  </main>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain:"valitec-mj.firebaseapp.com",
  projectId:"valitec-mj",
  storageBucket:"valitec-mj.appspot.com",
  messagingSenderId:"616592039657",
  appId:"1:616592039657:web:3827a890474111be85da78"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* ============== CONFIG CLOUDINARY ============== */
const CLOUDINARY_CLOUD = "dnfvzp3vu";          // seu cloud name
const CLOUDINARY_PRESET = "valitec_upload";    // seu upload preset (unsigned)
const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`;

/* ================== VARI√ÅVEIS GERAIS ================== */
const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];
const friendly = {
  loja_cd_cidade: "CD Cidade",
  loja_cidade: "Cidade Nova",
  loja_terranova: "Terra Nova",
  loja_manoa: "Manoa",
  loja_zumbi: "Zumbi",
  loja_oswaldo: "Oswaldo",
  loja_mosaico: "Mosaico"
};

const urlParams = new URLSearchParams(window.location.search);
const lojaURL = urlParams.get("loja");
let lojaAtual = null;
let produtoId = urlParams.get("id");
let fotoBlob = null;      // Blob que ser√° enviado ao Cloudinary
let fotoBase64 = null;    // para preview (opcional)
let codeReader = null;
let scannerActive = false;

/* ================== ELEMENTOS ================== */
const nomeEl = document.getElementById("nome");
const codigoEl = document.getElementById("codigo");
const loteEl = document.getElementById("lote");
const precoEl = document.getElementById("preco");
const setorEl = document.getElementById("setor");
const validadeEl = document.getElementById("validade");
const previewEl = document.getElementById("previewFoto");
const inputFileEl = document.getElementById("foto");
const scannerPreview = document.getElementById("scannerPreview");
const selectLojaInline = document.getElementById("selectLojaInline");
const cameraPreview = document.getElementById("cameraPreview");
const btnOpenCamera = document.getElementById("btnOpenCamera");
const btnCapturar = document.getElementById("btnCapturar");
const btnOpenFile = document.getElementById("btnOpenFile");
const btnSalvar = document.getElementById("btnSalvar");
const btnLimpar = document.getElementById("btnLimpar");
const formProduto = document.getElementById("formProduto");

/* ================== HELPERS ================== */
function parsePrice(v){ return Number(String(v).replace(".","").replace(",",".")) || 0; }
function convISO(br){ if(!br) return ""; if(br.includes("/")){ let[dd,mm,yy]=br.split("/"); return `${yy}-${mm}-${dd}`; } return br; }
function convBR(iso){ if(!iso) return ""; let[y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

/* ================== POPULA SELECT LOJAS ================== */
if (selectLojaInline) {
  lojasValidas.forEach(l=>{
    const o=document.createElement("option");
    o.value=l;
    o.textContent=friendly[l] || l;
    selectLojaInline.appendChild(o);
  });
}

/* ================== SCANNER (ZXing) ================== */
function startScanner(){
  if(scannerActive) return;
  if(!window.ZXing) return alert("Scanner n√£o dispon√≠vel neste dispositivo.");
  codeReader = new ZXing.BrowserMultiFormatReader();
  scannerActive = true;
  scannerPreview.style.display = "block";
  codeReader.decodeFromVideoDevice(null, scannerPreview, result => {
    if(result){ codigoEl.value = result.text; stopScanner(); }
  });
}
function stopScanner(){
  scannerActive = false;
  if(codeReader){ try{ codeReader.reset(); }catch(e){} }
  if(scannerPreview) scannerPreview.style.display = "none";
}
const btnScan = document.getElementById("btnScan");
if(btnScan) btnScan.onclick = ()=>{ if(scannerActive) stopScanner(); else startScanner(); };

/* ================== C√ÇMERA ================== */
if(btnOpenCamera) btnOpenCamera.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    cameraPreview.srcObject = stream;
    cameraPreview.style.display = "block";
    btnCapturar.style.display = "inline-block";
  }catch(e){ alert("Erro ao acessar c√¢mera: " + (e.message || e)); }
};

if(btnCapturar) btnCapturar.onclick = async ()=>{
  await new Promise(r=>setTimeout(r,700));
  if(!cameraPreview.videoWidth){ alert("C√¢mera carregando, tente novamente."); return; }

  const canvas = document.createElement("canvas");
  canvas.width = cameraPreview.videoWidth;
  canvas.height = cameraPreview.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(cameraPreview,0,0);
  const dataURL = canvas.toDataURL("image/jpeg",0.9);

  previewEl.src = dataURL;
  previewEl.style.display = "block";

  fotoBlob = await (await fetch(dataURL)).blob();
};

/* ================== INPUT ARQUIVO ================== */
if(inputFileEl) inputFileEl.onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    fotoBase64 = ev.target.result;
    previewEl.src = fotoBase64;
    previewEl.style.display="block";
    fotoBlob = await (await fetch(fotoBase64)).blob();
  };
  reader.readAsDataURL(file);
};

if(btnOpenFile) btnOpenFile.onclick = ()=> inputFileEl.click();

/* ================== UPLOAD CLOUDINARY ================== */
async function uploadToCloudinary(blob, publicIdPrefix){
  if(!blob) throw new Error("Nenhum arquivo para enviar.");
  const fd = new FormData();
  fd.append("file", blob);
  fd.append("upload_preset", CLOUDINARY_PRESET);
  // public_id opcional: usamos prefix/uuid para organizar por loja
  if(publicIdPrefix) fd.append("public_id", publicIdPrefix);
  // permitir retorno em JSON
  const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: "POST", body: fd });
  if(!res.ok){
    const txt = await res.text().catch(()=>"");
    throw new Error("Cloudinary upload falhou: " + res.status + " " + txt);
  }
  const json = await res.json();
  return json; // cont√©m secure_url, public_id, etc
}

/* ================== AUTENTICA√á√ÉO E CONTEXTO DA LOJA ================== */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href = "index.html";

  const snap = await getDoc(doc(db,"usuarios",user.email));
  if(!snap.exists()){ alert("Perfil n√£o encontrado."); return location.href="index.html"; }

  const cargo = snap.data().cargo || "gerente";
  const lojaUser = snap.data().loja;

  // Permiss√µes: somente responsavel/gerente/master podem acessar
  if(cargo!="responsavel" && cargo!="gerente" && cargo!="master"){
    alert("Sem permiss√£o para acessar esta p√°gina."); return location.href="dashboard.html";
  }

  // Definir lojaAtual e UI do select
  if(cargo==="responsavel"){
    lojaAtual = lojasValidas.includes(lojaURL) ? lojaURL : (localStorage.getItem("lastSelectedLoja") || lojaUser);
    if(selectLojaInline){
      selectLojaInline.style.display = "inline-block";
      selectLojaInline.value = lojaAtual;
      selectLojaInline.onchange = ()=>{
        const nova = selectLojaInline.value;
        localStorage.setItem("lastSelectedLoja",nova);
        // recarrega mantendo id se existir
        const params = new URLSearchParams(window.location.search);
        if(produtoId) params.set("id", produtoId);
        params.set("loja", nova);
        window.location.search = params.toString();
      };
    }
  } else {
    lojaAtual = lojaUser;
    if(selectLojaInline) selectLojaInline.style.display = "none";
  }

  // Carregar produto para edi√ß√£o (se aplic√°vel)
  if(produtoId){
    try{
      const pSnap = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      if(pSnap.exists()){
        const p = pSnap.data();
        nomeEl.value = p.nome || "";
        codigoEl.value = p.codigo || "";
        loteEl.value = p.lote || "";
        precoEl.value = p.preco || "";
        setorEl.value = p.setor || "";
        validadeEl.value = p.dataValidadeISO || "";
        document.getElementById("quantidade").value = p.quantidade ?? 0;
        if(p.fotoURL){ previewEl.src = p.fotoURL; previewEl.style.display = "block"; }
        document.getElementById("tituloPaginaTexto")?.textContent = "Editar Produto";
        document.getElementById("btnSalvar")?.textContent = "Salvar Altera√ß√µes";
      } else {
        // produto n√£o encontrado ‚Äî pode ser em outra loja
        // console.warn("Produto n√£o encontrado na loja atual.");
      }
    }catch(e){
      console.error("Erro ao carregar produto:", e);
    }
  }
});

/* ================== SALVAR PRODUTO (usa Cloudinary) ================== */
document.getElementById("btnSalvar").onclick = async ()=>{
  // evita duplo clique
  btnSalvar.disabled = true;
  btnSalvar.textContent = "Enviando...";

  // Fecha a c√¢mera se aberta
  try{ if(cameraPreview.srcObject){ cameraPreview.srcObject.getTracks().forEach(t=>t.stop()); cameraPreview.srcObject = null; } }catch(e){}
  cameraPreview.style.display="none";

  const nome = nomeEl.value.trim();
  const codigo = codigoEl.value.trim();
  const lote = loteEl.value.trim();
  const preco = parsePrice(precoEl.value);
  const quantidade = Number(document.getElementById("quantidade").value || 0);
  const setor = setorEl.value;
  const iso = validadeEl.value;

  if(!nome || !codigo || !lote || !iso){
    alert("Preencha todos os campos obrigat√≥rios (nome, c√≥digo, lote, validade).");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  if(!lojaAtual){
    alert("Loja n√£o definida. Verifique seu perfil e a sele√ß√£o de loja.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  const id = produtoId || crypto.randomUUID();
  let fotoURL = "";

  // Se houver fotoBlob, faz upload ao Cloudinary
  try{
    if(fotoBlob){
      // Monta public_id para organizar: lojaAtual/<id>
      const publicId = `${lojaAtual}/${id}`;
      const uploaded = await uploadToCloudinary(fotoBlob, publicId);
      fotoURL = uploaded.secure_url || uploaded.url || "";
    } else if(produtoId){
      // editar sem nova foto: mant√©m foto anterior (se existir)
      const snapOld = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      fotoURL = snapOld.exists() ? (snapOld.data().fotoURL || "") : "";
    } else {
      // novo produto sem foto: deixa vazio
      fotoURL = "";
    }
  }catch(e){
    console.error("Erro upload Cloudinary:", e);
    alert("Erro ao enviar foto. Veja console.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  // Salva no Firestore
  try{
    await setDoc(doc(db,`lojas/${lojaAtual}/produtos/${id}`), {
      nome,
      codigo,
      lote,
      preco,
      quantidade,
      setor,
      dataValidadeISO: iso,
      dataValidadeBR: convBR(iso),
      fotoURL,
      status: "normal",
      alertaCor: "normal",
      alert5diasSent: false,
      criadoEm: produtoId ? undefined : new Date(),
      atualizadoEm: new Date()
    }, { merge: true });

    alert("Produto salvo com sucesso!");
    location.href = "Lista-produtos.html";
  }catch(err){
    console.error("Erro ao salvar produto:", err);
    alert("Erro ao salvar produto. Veja console.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto";
  }
};

/* ================== LIMPAR FORM ================== */
document.getElementById("btnLimpar").onclick = ()=>{
  try{ formProduto.reset(); }catch(e){}
  previewEl.style.display="none";
  stopScanner();
  fotoBlob = null;
};
</script>


<script>
/* hamburger */
const btnMenu = document.getElementById('btnMenu'); const sidebarMenu = document.getElementById('sidebarMenu'); btnMenu.onclick = ()=> sidebarMenu.classList.toggle('open');
</script>
</body>
</html>
