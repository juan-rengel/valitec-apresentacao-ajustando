<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ValiTec MJ â€” Cadastro de Produto</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="dashboard.css">
<link rel="stylesheet" href="theme.css">

<style>
body { font-family: 'Poppins', sans-serif; }
.hamburger {
  display: none; position: fixed; top: 15px; left: 15px; font-size: 28px;
  background: var(--accent); color: #fff; border: none; border-radius: 6px;
  padding: 6px 12px; z-index: 9999; cursor: pointer;
}
@media(max-width: 900px) {
  .hamburger { display: block; }
  .sidebar { position: fixed; left: -260px; top: 0; height: 100vh; transition: .3s; z-index: 9998; }
  .sidebar.open { left: 0; }
  .main { margin-left: 0 !important; }
}
.foto-area { display:flex; gap:10px; align-items:center; }

#excelModal {
  position:fixed; inset:0; background:rgba(0,0,0,0.5);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
#excelModal .card {
  background:#0a1323; padding:20px; border-radius:12px; width:95vw; max-width:980px;
  color:white; border:1px solid #00c8ff;
}
#excelModal table { width:100%; border-collapse:collapse; font-size:13px; }
#excelModal th, #excelModal td {
  padding:8px; border-bottom:1px solid rgba(255,255,255,0.1);
}
.row-invalid { background:rgba(255,60,60,0.1); }
.row-valid { background:rgba(60,255,120,0.1); }

.theme-toggle {
  position:fixed; right:16px; bottom:16px; padding:10px;
  border:none; border-radius:8px; cursor:pointer;
}

/* small inline loja selector style */
#lojaInlineRow { display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:12px; }
#selectLojaInline { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; }



/* bloco adicionado para testar la imagen tomada pela camera */
.preview-img {
  width: 100%;
  max-width: 180px;
  height: 180px;
  object-fit: cover;
  border-radius: 10px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

/* Corrige a cÃ¢mera estourando layout */
.foto-area video {
  max-width: 160px !important;
  max-height: 160px !important;
  border-radius: 10px;
  object-fit: cover;
  background: #000;
}

#previewFoto {
  width: 160px !important;
  height: 160px !important;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #fff;
}
</style>

</head>
<body>

<canvas id="particleCanvas"></canvas>

<div class="app-container">

<button id="btnMenu" class="hamburger">â˜°</button>

<aside class="sidebar" id="sidebarMenu">
<nav>
  <a href="dashboard.html">Painel</a>
  <a href="#" class="active">Cadastrar Produtos</a>
  <a href="Lista-produtos.html">Lista de Produtos</a>
  <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
  <a href="calendario.html">CalendÃ¡rio</a>
  <a href="perfil.html">Perfil</a>
  <a href="cadastro-usuarios.html">Cadastrar UsuÃ¡rios</a>
  <a href="relatorios.html">RelatÃ³rios</a>
  <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
</nav>
</aside>

<main class="main">
<h2 id="tituloPagina" style="text-align:center;display:inline-block;">Cadastrar Produto</h2>

<!-- Novo: seletor de loja inline (aparecerÃ¡ sÃ³ para 'responsavel') -->
<div id="lojaInlineRow" style="display:flex;justify-content:center;align-items:center;">
  <label style="margin:0 6px 0 0;font-weight:600;">Loja:</label>
  <select id="selectLojaInline" aria-label="Selecionar loja"></select>
</div>

<form id="formProduto" class="form-produto">

    <label>Nome do roduto</label>
    <input type="text" id="nome" required>

    <label>CÃ³digo de Barras</label>
    <div class="form-row">
        <input type="text" id="codigo" placeholder="Aguardando leitura..." required>
        <button type="button" id="btnScan">ðŸ“· Ler</button>
    </div>

    <video id="scannerPreview"
           style="display:none;width:260px;margin-top:10px;border:1px solid #fff;border-radius:8px;">
    </video>

    <label>Lote</label>
    <input type="text" id="lote" required>

    <label>PreÃ§o</label>
    <input type="text" id="preco" required placeholder="0,00">

    <label>Quantidade</label>
    <input type="number" id="quantidade" required placeholder="0">

    <label>Setor</label>
    <select id="setor" required>
        <option value="Mercearia">Mercearia</option>
        <option value="Bebidas">Bebidas</option>
        <option value="Frios">Frios</option>
        <option value="Higiene">Higiene</option>
        <option value="Limpeza">Limpeza</option>
        <option value="AÃ§ougue">AÃ§ougue</option>
        <option value="Outros">Outros</option>
    </select>

    <label>Data de Validade</label>
    <input type="date" id="validade" required>

    <label>Foto do Produto</label>
    <div class="foto-area">
        <video id="cameraPreview" autoplay playsinline
               style="display:none;width:200px;border-radius:8px;"></video>

        <img id="previewFoto"
             style="display:none;width:120px;border-radius:6px;border:1px solid #fff;">

        <input type="file" id="foto" accept="image/*" style="display:none;">

        <button type="button" id="btnOpenCamera">ðŸ“· Abrir CÃ¢mera</button>
        <button type="button" id="btnCapturar" style="display:none;">Capturar</button>
    </div>

    <button type="button" id="btnSalvar" class="btnMain">Salvar Produto</button>
    <button type="button" id="btnLimpar" class="btnSecondary">Limpar</button>

</form>


<button id="importExcelBtn" style="margin-top:20px;">Importar Excel</button>
<input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none;">

<div id="excelModal">
  <div class="card">
    <h2>PrÃ©-visualizaÃ§Ã£o</h2>
    <table id="excelTable">
      <thead>
        <tr>
          <th>Nome</th><th>CÃ³digo</th><th>Lote</th><th>Validade</th><th>PreÃ§o</th><th>Fornecedor</th><th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:14px;text-align:right;">
      <button id="closeExcelModal">Fechar</button>
      <button id="saveAllLines">Salvar Tudo</button>
    </div>
  </div>
</div>

</main>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const btnMenu = document.getElementById("btnMenu");
const sidebarMenu = document.getElementById("sidebarMenu");
btnMenu.onclick = () => sidebarMenu.classList.toggle("open");
</script>

<script type="module">
/* Nenhum comentÃ¡rio aqui dentro â€” tudo limpo */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain:"valitec-mj.firebaseapp.com",
  projectId:"valitec-mj",
  storageBucket:"valitec-mj.firebasestorage.app",
  messagingSenderId:"616592039657",
  appId:"1:616592039657:web:3827a890474111be85da78"
});

const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

/* ================== NOVAS VARIÃVEIS (LOJAS + UI) ================== */
const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];
const friendly = {
  loja_cd_cidade: "CD Cidade",
  loja_cidade: "Cidade Nova",
  loja_terranova: "Terra Nova",
  loja_manoa: "Manoa",
  loja_zumbi: "Zumbi",
  loja_oswaldo: "Oswaldo",
  loja_mosaico: "Mosaico"
};
const urlParams = new URLSearchParams(window.location.search);
const lojaURL = urlParams.get("loja");

let lojaAtual = null;
let produtoId = new URLSearchParams(location.search).get("id");
let fotoBlob = null;
let codeReader = null;
let scannerActive = false;

const nomeEl = document.getElementById("nome");
const codigoEl = document.getElementById("codigo");
const loteEl = document.getElementById("lote");
const precoEl = document.getElementById("preco");
const setorEl = document.getElementById("setor");
const validadeEl = document.getElementById("validade");
const previewEl = document.getElementById("previewFoto");
const inputFileEl = document.getElementById("foto");
const scannerPreview = document.getElementById("scannerPreview");
const selectLojaInline = document.getElementById("selectLojaInline");

/* montar select inline (sempre, depois escondemos quando preciso) */
lojasValidas.forEach(l=>{
  const o = document.createElement("option");
  o.value = l;
  o.textContent = friendly[l] || l;
  selectLojaInline.appendChild(o);
});

/* === Conversores === */
function parsePrice(v){if(!v)return 0;return Number(String(v).replace(".","").replace(",","."));}

function convISO(br){
  if(br.includes("/")){let[dd,mm,yy]=br.split("/");return `${yy}-${mm}-${dd}`;}
  return br;
}
function convBR(iso){
  if(!iso) return "";
  let[y,m,d]=iso.split("-");return `${d}/${m}/${y}`;
}

/* === SCANNER === */
function startScanner(){
  if(scannerActive) return;
  if(!window.ZXing) return alert("Scanner nÃ£o disponÃ­vel.");
  codeReader = new ZXing.BrowserMultiFormatReader();
  scannerActive=true;
  scannerPreview.style.display="block";
  codeReader.decodeFromVideoDevice(null,scannerPreview,(res)=>{
    if(res){codigoEl.value=res.text;stopScanner();}
  });
}
function stopScanner(){
  if(!scannerActive)return;
  scannerActive=false;
  if(codeReader){try{codeReader.reset();}catch(e){}}
  scannerPreview.style.display="none";
}
document.getElementById("btnScan").onclick=()=>{
  if(scannerActive) stopScanner(); else startScanner();
};

/* === CÃ‚MERA === */
const cameraPreview=document.getElementById("cameraPreview");
const btnOpenCamera=document.getElementById("btnOpenCamera");
const btnCapturar=document.getElementById("btnCapturar");

btnOpenCamera.onclick=async()=>{
  try{
    let s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    cameraPreview.srcObject=s;
    cameraPreview.style.display="block";
    btnCapturar.style.display="inline-block";
  }catch(e){alert("Erro cÃ¢mera.");}
};
btnCapturar.onclick = async () => {

  // Aguarda carregamento garantido
  await new Promise(res => setTimeout(res, 600));

  const video = cameraPreview;

  if (!video || video.videoWidth === 0) {
      alert("A cÃ¢mera ainda estÃ¡ carregando. Tente novamente.");
      return;
  }

  // Canvas fixo e seguro
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Gera imagem
  const dataURL = canvas.toDataURL("image/jpeg", 0.85);

  // Mostra preview sem quebrar
  previewFoto.src = dataURL;
  previewFoto.style.display = "block";

  // Converte para Blob
  fotoBlob = await (await fetch(dataURL)).blob();

  console.log("ðŸ“¸ Foto capturada:", fotoBlob);

  // Fecha a cÃ¢mera imediatamente (evita zoom quebrar tela)
  try {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }
    video.style.display = "none";
    btnCapturar.style.display = "none";
  } catch (e) {}
};

/* ================== AUTENTICAÃ‡ÃƒO e CONFIG LOJA ================== */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href = "index.html";

  const snap = await getDoc(doc(db,"usuarios",user.email));
  if(!snap.exists()){
    alert("Erro ao carregar perfil do usuÃ¡rio.");
    return location.href = "index.html";
  }

  const cargo = snap.data().cargo || "gerente";
  const lojaUser = snap.data().loja;

  // ðŸ”’ BLOQUEIO DE ACESSO (mesma regra: responsavel/gerente/master allowed)
  if (cargo !== "responsavel" && cargo !== "gerente" && cargo !== "master") {
    alert("âŒ VocÃª nÃ£o tem permissÃ£o para acessar esta pÃ¡gina.");
    return location.href = "dashboard.html";
  }

  // Se for RESPONSÃVEL â†’ permite override via ?loja= ou via select (persistido)
  if (cargo === "responsavel") {
    lojaAtual = lojasValidas.includes(lojaURL) ? lojaURL : (localStorage.getItem("lastSelectedLoja") || lojaUser);
    // deixa select visÃ­vel e apontando para lojaAtual
    selectLojaInline.style.display = "inline-block";
    selectLojaInline.value = lojaAtual;
    selectLojaInline.onchange = () => {
      const nova = selectLojaInline.value;
      localStorage.setItem("lastSelectedLoja", nova);
      // recarrega mantendo id se existir
      const params = new URLSearchParams(window.location.search);
      if (params.get("id")) params.set("loja", nova);
      else params.set("loja", nova);
      window.location.search = params.toString();
    };
  } else {
    // gerente/master => loja fixa dele; esconde select
    lojaAtual = lojaUser;
    selectLojaInline.style.display = "none";
    // se URL tentar sobrescrever, ignorar e logar no console
    if (lojaURL && lojaURL !== lojaUser) {
      console.warn("Parametro ?loja= ignorado para este cargo.");
    }
  }

  // agora carregamos produto caso esteja editando
  if(produtoId){
    try{
      let pSnap = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      if(pSnap.exists()){
        let p = pSnap.data();
        nomeEl.value = p.nome || "";
        codigoEl.value = p.codigo || "";
        loteEl.value = p.lote || "";
        precoEl.value = p.preco || "";
        setorEl.value = p.setor || "";
        validadeEl.value = p.dataValidadeISO || "";
        document.getElementById("quantidade").value = p.quantidade ?? 0;
        if(p.fotoURL){
          previewEl.src = p.fotoURL;
          previewEl.style.display = "block";
        }
        document.getElementById("tituloPagina").textContent="Editar Produto";
        document.getElementById("btnSalvar").textContent="Salvar AlteraÃ§Ãµes";
      } else {
        // produtoId existe mas nÃ£o no caminho da loja atual - pode ser permissÃ£o / loja diferente
        console.warn("Produto nÃ£o encontrado na loja atual.");
      }
    }catch(e){
      console.error("Erro ao carregar produto:", e);
    }
  }
});

/* ================== SALVAR ================== */
document.getElementById("btnSalvar").onclick = async () => {

  // Fecha a cÃ¢mera antes de salvar (IMPORTANTE no Android/iOS)
  try {
    if (cameraPreview.srcObject) {
      cameraPreview.srcObject.getTracks().forEach(t => t.stop());
      cameraPreview.srcObject = null;
    }
    cameraPreview.style.display = "none";
  } catch(e){}

  const nome = nomeEl.value.trim();
  const codigo = codigoEl.value.trim();
  const lote = loteEl.value.trim();
  const preco = parsePrice(precoEl.value);
  const quantidade = Number(document.getElementById("quantidade").value);
  const setor = setorEl.value;
  const iso = validadeEl.value;

  if (!nome || !codigo || !lote || !iso) {
    alert("Preencha todos os campos.");
    return;
  }

  if (isNaN(quantidade)) {
    alert("Informe a quantidade.");
    return;
  }

  const id = produtoId || crypto.randomUUID();
  let fotoURL = "";

  // -------------------------------------------------------
  // ðŸ“¸ UPLOAD DA FOTO (correÃ§Ã£o completa)
  // -------------------------------------------------------
  try {

    if (fotoBlob) {
      // Foto nova -> envia SEMPRE
      const refImg = ref(storage, `produtos/${lojaAtual}/${id}.jpg`);
      await uploadBytes(refImg, fotoBlob);
      fotoURL = await getDownloadURL(refImg);

    } else if (produtoId) {
      // Sem foto nova, mas editando -> mantÃ©m foto antiga
      const snapOld = await getDoc(doc(db, `lojas/${lojaAtual}/produtos/${produtoId}`));
      fotoURL = snapOld.exists() ? (snapOld.data().fotoURL || "") : "";

    } else {
      // Novo produto sem foto -> deixa vazio
      fotoURL = "";
    }

  } catch (e) {
    console.error("Erro no upload da foto:", e);
    alert("Erro ao enviar a foto. Tente novamente.");
    return;
  }

  

  // -------------------------------------------------------
  // ðŸ“¦ NOVO BLOCO PARA TESTAR A CAMERA INICNIO
  // -------------------------------------------------------

  // -------------------------------------------------------
  // ðŸ“¦ Salvando produto
  // -------------------------------------------------------
  try {
    await setDoc(
      doc(db, `lojas/${lojaAtual}/produtos/${id}`),
      {
        nome,
        codigo,
        lote,
        preco,
        quantidade,
        setor,
        dataValidadeISO: iso,
        dataValidadeBR: convBR(iso),
        fotoURL,
        status: "normal",
        alertaCor: "normal",
        alert5diasSent: false,
        criadoEm: produtoId ? undefined : new Date(),
        atualizadoEm: new Date()
      },
      { merge: true }
    );

    alert("Produto salvo com sucesso!");
    location.href = "Lista-produtos.html";

  } catch (e) {
    console.error("Erro ao salvar produto:", e);
    alert("Erro ao salvar produto. Veja o console.");
  }
};

/* === LIMPAR === */
document.getElementById("btnLimpar").onclick=()=>{
  formProduto.reset();
  previewEl.style.display="none";
  fotoBlob=null;
  stopScanner();
};

/* === IMPORTAR EXCEL === */
const excelBtn=document.getElementById("importExcelBtn");
const excelInput=document.getElementById("excelInput");
const excelModal=document.getElementById("excelModal");
const excelClose=document.getElementById("closeExcelModal");
const tableBody=document.querySelector("#excelTable tbody");
const saveAll=document.getElementById("saveAllLines");

excelBtn.onclick=()=>excelInput.click();

excelInput.onchange=(e)=>{
  let file=e.target.files[0]; if(!file)return;
  let reader=new FileReader();
  reader.onload=(evt)=>{
    let wb=XLSX.read(new Uint8Array(evt.target.result),{type:"array"});
    let sheet=wb.Sheets[wb.SheetNames[0]];
    let json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    carregarTabela(json);
    excelModal.style.display="flex";
  };
  reader.readAsArrayBuffer(file);
};

function carregarTabela(lista){
  tableBody.innerHTML="";
  lista.forEach(item=>{
    const nome=item.nome||item.Nome||"";
    const cod=item.codigo||item.CÃ³digo||"";
    const lote=item.lote||"";
    const val=item.validade||item.Validade||"";
    const pr=item.preco||"";
    const forn=item.fornecedor||"";

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${nome}</td>
      <td>${cod}</td>
      <td>${lote}</td>
      <td>${val}</td>
      <td>${pr}</td>
      <td>${forn}</td>
      <td><button class="useLine">Usar</button></td>
    `;
    tableBody.appendChild(tr);

    tr.querySelector(".useLine").onclick=()=>{
      nomeEl.value=nome;
      codigoEl.value=cod;
      loteEl.value=lote;

      if(val.includes("/")){
        let[d,m,y]=val.split("/");
        validadeEl.value=`${y}-${m}-${d}`;
      }else{
        validadeEl.value=val;
      }
      precoEl.value=pr;
      excelModal.style.display="none";
    };
  });
}

excelClose.onclick=()=>excelModal.style.display="none";

saveAll.onclick=async()=>{
  let rows=document.querySelectorAll("#excelTable tbody tr");
  if(rows.length===0){alert("Nada a salvar.");return;}

  let ok=0,fail=0;
  for(let r of rows){
    let nome=r.cells[0].innerText.trim();
    let cod=r.cells[1].innerText.trim();
    let lote=r.cells[2].innerText.trim();
    let val=r.cells[3].innerText.trim();
    let pr=parsePrice(r.cells[4].innerText.trim());
    let forn=r.cells[5].innerText.trim();

    if(!nome||!cod||!lote||!val){fail++;continue;}

    let iso=convISO(val);
    await setDoc(doc(db,`lojas/${lojaAtual}/produtos/${crypto.randomUUID()}`),{
      nome,codigo:cod,lote,preco:pr,fornecedor:forn||"",
      setor:"Outros",
      dataValidadeISO:iso,
      dataValidadeBR:convBR(iso),
      fotoURL:"",
      status:"normal",
      alertaCor:"normal",
      alert5diasSent:false,
      criadoEm:new Date()
    });
    ok++;
  }
  alert("Enviados: "+ok+" | Falhas: "+fail);
  excelModal.style.display="none";
};
</script>

<button id="toggleTheme" class="theme-toggle">ðŸŒ™</button>
<script>
const toggle=document.getElementById("toggleTheme");
function aplicaTema(){
  let t=localStorage.getItem("temaValitec")||"dark";
  if(t==="light"){document.documentElement.classList.add("light-mode");toggle.textContent="ðŸŒ™";}
  else{document.documentElement.classList.remove("light-mode");toggle.textContent="ðŸ”†";}
}
toggle.onclick=()=>{
  let t=localStorage.getItem("temaValitec")||"dark";
  let n=t==="dark"?"light":"dark";
  localStorage.setItem("temaValitec",n);
  aplicaTema();
};
aplicaTema();
</script>

</body>
</html>
