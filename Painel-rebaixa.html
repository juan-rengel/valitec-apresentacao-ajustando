<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ‚Äî Respons√°vel Rebaixa (v2) ‚Äî ValiTec MJ</title>

  <!-- Import fonts + system CSS (mantive refer√™ncias ao seu dashboard.css / theme.css) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="theme.css">


  <style>
/* ===========================
   STYLES PARA panel-rebaixa
   (substituir o <style> atual)
   =========================== */

/* Vari√°veis de tema */
:root {
  --accent: #6cdbfa;
  --muted: #000c1d;
  --glass: rgba(51, 18, 241, 0.774);
  --radius: 14px;

  --bg: #f5f5f5;
  --text: #1d1d1d;
  --card: #ffffff;
  --shadow: rgba(0,0,0,0.12);
}

/* Tema escuro */
.dark {
  --bg: #080324;
  --text: #eef2f7;
  --card: #06062e2a;
  --shadow: rgba(0, 0, 0, 0.753);
  
 
}

/* Reset/Global */
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; padding: 0; }
body {
  font-family: "Poppins", sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background .25s ease, color .25s ease;
  min-height: 100vh;
  position: relative;
}

/* Part√≠culas (canvas) */
#particleCanvas {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
}

/* CONTAINER PRINCIPAL */
.app-container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  max-width: 1600px;
  padding: 20px;
  margin: 36px auto;
  position: relative;
  z-index: 2;
}

/* SIDEBAR */
.sidebar {
  width: 260px;
  background: var(--card);
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 8px 24px var(--shadow);
  height: calc(100vh - 72px);
  box-sizing: border-box;
  position: sticky;
  top: 36px;
  overflow: auto;
   
}

.sidebar nav a {
  display: block;
  padding: 30px 12px;
  color: var(--muted);
  border-radius: 8px;
  text-decoration: none;
  margin-bottom: 6px;
  font-weight: 600;
  transition: background .12s ease, color .12s ease, transform .12s;

}

.sidebar nav a:hover {
  transform: translateY(-2px);
}

.sidebar nav a.active,
.sidebar nav a:hover {
  background: var(--glass);
  color: var(--text);
}

/* MAIN AREA */
.main {
  flex: 1;
  min-width: 0;
  z-index: 3;
}

/* HEADER */
header.app-header {
  background: var(--card);
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 8px 24px var(--shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

header.app-header h1 {
  font-size: 18px;
  margin: 0;
  font-weight: 700;
  color: var(--text);
}

header.app-header .small {
  color: var(--muted);
  font-size: 13px;
  padding: 15px;
}

/* BARRA DE A√á√ÉO / SELE√á√ÉO DE LOJA */
.barra-acao {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.barra-acao .loja-info {
  font-weight: 700;
  color: var(--muted);
  margin-right: 6px;
 
}

.barra-acao select {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.06);
  background: var(--card);
  color: var(--text);
  min-width: 220px;
  outline: none;
}

.barra-acao select:focus {
  box-shadow: 0 0 0 4px rgba(0,200,255,0.06);
  border-color: var(--accent);
}

/* BOT√ïES GENERICOS */
.btn {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  
}

.btn.primary {
  background: linear-gradient(90deg,#00b4d8,#009bff);
  color: #071322;
  box-shadow: 0 8px 20px rgba(0,200,255,0.12);
}

.btn.ghost {
  background: transparent;
  border: 1px solid rgba(0,0,0,0.06);
 
}

/* GRID DE CARDS */
.grid-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 18px;
}

/* CARD */
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: 0 12px 30px var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-start;
  transition: transform .18s ease, box-shadow .18s ease;
  cursor: pointer;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px var(--shadow);
}

.card h3 { margin: 0; font-size: 18px; color: var(--text); }
.card p { margin: 0; color: var(--muted); font-size: 13px; }

/* ICON */
.icon {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  display: inline-grid;
  place-items: center;
  background: var(--glass);
  color: var(--accent);
  font-weight: 700;
  font-size: 16px;
}

/* CTA / CONTATO GERENTE */
.cta-wrap { margin-top: 18px; display: flex; gap: 12px; align-items: center; }
.btnContato {
  flex: 1;
  background: linear-gradient(90deg,#00d08a,#00aaff);
  border: none;
  padding: 14px 18px;
  border-radius: 12px;
  color: #00131e;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 12px 30px rgba(0,200,255,0.08);
  transition: transform .12s ease, opacity .12s ease;
}

.btnContato:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  filter: grayscale(.25);
  transform: none;
}

/* RESPONSIVO */
@media (max-width: 980px) {
  .app-container {
    padding: 16px;
    margin: 16px;
    display: block;
    }
  }
  .sidebar {
    width: 20%;
    height: auto;
    position: relative;
    top: 0;
    margin-bottom: 12px;
  }
  .barra-acao select { min-width: 100%;
   
}

/* pequenas melhorias visuais */
a, button { -webkit-tap-highlight-color: transparent; }



/* Bot√£o hamburguer */
.menu-toggle {
  display: none; /* desktop escondido */
  position: absolute;
  left: 0;
  top: 0;
  font-size: 25px;
  cursor: pointer;
  z-index: 2000;
  color: #2e2e2e;
}

/* Modo mobile */
@media screen and (max-width: 860px) {

  .menu-toggle {
    display: block; /* mostra no mobile */
  }

  .sidebar {
    position: fixed;
    top: 0px;
    
    width: 240px;
    

    padding-top: 20px;
    transition: left 0.3s ease;
    z-index: 1500;
  }

  .sidebar.open {
    left: 0;
  }

  body.menu-open .content,
  body.menu-open .header {
    margin-left: 240px;
  }
}


  </style>

</head>
<body>
<header><button class="menu-toggle" id="menuToggle">
  ‚ò∞
</button></header>
<canvas id="particleCanvas"></canvas>
<div class="app-container">
  <!-- SIDEBAR (keeps same structure as app) -->
  <aside class="sidebar">
    <nav>
      <a href="dashboard.html">Painel</a>
      <a href="produto.html">Cadastrar Produto</a>
      <a href="Lista-produtos.html">Lista de Produtos</a>
      <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
      <a href="calendario.html">Calend√°rio</a>
      <a href="perfil.html">Perfil</a>
      <a href="cadastro-usuarios.html">Cadastrar Usu√°rios</a>
      <a href="relatorios.html">Relat√≥rios</a>
      <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
    </nav>
  </aside>
  
  <main class="main">
    <header class="app-header">
      
      <div>
        <h1>Painel ‚Äî Respons√°vel Rebaixa</h1>
        <div class="small">Acesso r√°pido √†s a√ß√µes de rebaixa e comunica√ß√£o com gerentes</div>
      </div>
      <div>
        <button id="btnTema" title="Alternar tema" class="btn">Tema</button>
      </div>
    </header>

    <!-- Barra de a√ß√£o / sele√ß√£o de loja (persistente para respons√°vel) -->
    <div class="barra-acao">
      <div class="loja-info">Loja atual:</div>
      <select id="selectLoja" aria-label="Selecionar loja">
        <option value="">Selecionar...</option>
        <option value="loja_cd_cidade">CD Cidade</option>
        <option value="loja_cidade">Cidade Nova</option>
        <option value="loja_terranova">Terra Nova</option>
        <option value="loja_manoa">Manoa</option>
        <option value="loja_zumbi">Zumbi</option>
        <option value="loja_oswaldo">Oswaldo</option>
        <option value="loja_mosaico">Mosaico</option>
      </select>

      <button id="btnVoltarPainel" class="btn" style="background:transparent;border:1px solid rgba(0,0,0,0.06);">Voltar ao Painel</button>
    </div>

    <!-- Grid de cards -->
    <section class="grid-cards" id="cardsWrap">
      <div class="card" id="cardProdutos" onclick="acessar('Lista-produtos.html')">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="icon">P</div>
          <div style="flex:1;">
            <h3>Lista de Produtos</h3>
            <p>Visualizar produtos da loja selecionada</p>
          </div>
        </div>
      </div>

      <div class="card" id="cardRebaixados" onclick="acessar('Lista-rebaixados.html')">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="icon">R</div>
          <div style="flex:1;">
            <h3>Produtos Rebaixados</h3>
            <p>Ver rebaixas da loja selecionada</p>
          </div>
        </div>
      </div>

      <div class="card" id="cardCalendario" onclick="acessar('calendario.html')">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="icon">C</div>
          <div style="flex:1;">
            <h3>Calend√°rio</h3>
            <p>Consultar vencimentos por data</p>
          </div>
        </div>
      </div>

      <div class="card" id="cardRelatorios" onclick="acessar('relatorios.html')">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="icon">L</div>
          <div style="flex:1;">
            <h3>Relat√≥rios</h3>
            <p>Relat√≥rios e exporta√ß√µes por loja</p>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA para contato com gerente -->
    <div class="cta-wrap">
      <button id="btnGerente" class="btnContato" disabled>üì≤ Falar com o Gerente (WhatsApp)</button>
    </div>

  </main>
</div>
<!-- scripts (keeps firebase logic + behavior) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
    authDomain: "valitec-mj.firebaseapp.com",
    projectId: "valitec-mj",
    storageBucket: "valitec-mj.firebasestorage.app",
    messagingSenderId: "616592039657",
    appId: "1:616592039657:web:3827a890474111be85da78"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const selectLoja = document.getElementById("selectLoja");
  const btnGerente = document.getElementById("btnGerente");
  const btnVoltar = document.getElementById("btnVoltarPainel");
  let gerenteTelefone = null;
  let cargoLocal = localStorage.getItem("cargo"); // fallback quick check

  // persist last selected loja
  const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];

  // Helper abrir whatsapp
  function abrirWhatsNumero(numero, texto){
    if(!numero) return alert("N√∫mero n√£o configurado.");
    const only = numero.replace(/\D/g,"");
    const url = `https://wa.me/55${only}?text=${encodeURIComponent(texto)}`;
    window.open(url,"_blank");
  }

  // monta select com lastSelectedLoja (se houver)
  function aplicarLojaInicial(loja){
    if(!loja) loja = localStorage.getItem("lastSelectedLoja") || "";
    if(loja && lojasValidas.includes(loja)){
      selectLoja.value = loja;
    } else {
      selectLoja.value = "";
    }
  }

  // Ao mudar loja no select -> salva e busca gerente
  selectLoja.onchange = async () => {
    const loja = selectLoja.value;
    localStorage.setItem("lastSelectedLoja", loja);
    btnGerente.disabled = true;
    gerenteTelefone = null;

    if (!loja) return;

    try {
      const q = query(collection(db, "usuarios"),
        where("cargo", "==", "gerente"),
        where("loja", "==", loja)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        gerenteTelefone = null;
        btnGerente.disabled = true;
        return;
      }
      const g = snap.docs[0].data();
      // tenta dois campos poss√≠veis, para m√°xima compatibilidade
      gerenteTelefone = g.whatsGerente || g.whatsapp || g.whats || null;
      btnGerente.disabled = !gerenteTelefone;
    } catch (e) {
      console.error("Erro buscar gerente:", e);
      gerenteTelefone = null;
      btnGerente.disabled = true;
    }
  };

  btnGerente.onclick = () => {
    if (!gerenteTelefone) return alert("Gerente n√£o possui WhatsApp cadastrado.");
    const lojaId = selectLoja.value;
    const usuario = localStorage.getItem("usuarioLogado") || "responsavel";
    const msg = `Ol√°, Gerente! O respons√°vel pela rebaixa (${usuario}) est√° revisando produtos da sua loja (${lojaId}).`;
    abrirWhatsNumero(gerenteTelefone, msg);
  };

  btnVoltar.onclick = () => location.href = "dashboard.html";

  // acessar p√°ginas com ?loja=
  window.acessar = (pagina) => {
    const loja = selectLoja.value;
    if (!loja) return alert("Selecione uma loja primeiro.");
    window.location.href = `${pagina}?loja=${encodeURIComponent(loja)}`;
  };

  // Checagem de cargo e autoriza√ß√£o via Firebase auth -> garante estado correto (robusto)
  onAuthStateChanged(auth, async (user) => {
    // Se n√£o houver usu√°rio logado via Firebase, tenta fallback para localStorage cargo
    if (!user) {
      // se n√£o tiver cargo no localstorage, manda para index
      if (!cargoLocal) return location.href = "index.html";
      // se cargo existir, permitir s√≥ se responsavel
      if (cargoLocal !== "responsavel") return location.href = "index.html";
      aplicarLojaInicial(localStorage.getItem("lastSelectedLoja"));
      return;
    }

    try {
      const snap = await getDoc(doc(db, "usuarios", user.email));
      if (!snap.exists()) {
        alert("Usu√°rio sem perfil.");
        return location.href = "index.html";
      }
      const dados = snap.data();
      const cargo = dados.cargo || localStorage.getItem("cargo") || "";
      // somente respons√°vel pode usar este painel (conforme config original)
      if (cargo !== "responsavel") {
        // se for master permitir visualizar (opcional) ‚Äî mantive bloqueio original: redirect
        return location.href = "index.html";
      }
      // aplica loja padr√£o do usu√°rio (mas resp. pode trocar)
      const lojaUser = dados.loja || localStorage.getItem("loja") || "";
      aplicarLojaInicial(localStorage.getItem("lastSelectedLoja") || lojaUser);
    } catch (e) {
      console.error("Erro auth check:", e);
      aplicarLojaInicial(localStorage.getItem("lastSelectedLoja"));
    }
  });
</script>

<!-- Theme toggle + Particles + small helpers -->
<script>
  // Theme toggle (keeps same simple behavior)
  const btnTema = document.getElementById("btnTema");
  let tema = localStorage.getItem("theme");
  if (tema === "dark") document.documentElement.classList.add("dark");
  btnTema.addEventListener("click", () => {
    document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
  });

  // Particles background (small, cheap)
  (function(){
    const canvas = document.getElementById("particleCanvas");
    const ctx = canvas.getContext("2d");
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    resize(); addEventListener("resize", resize);
    const particles = Array.from({length:60}).map(()=>({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight,
      r: Math.random()*2+0.6,
      dx: (Math.random()-0.5)*0.4,
      dy: (Math.random()-0.5)*0.4
    }));
    function loop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(0,200,255,0.06)";
      for(const p of particles){
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        p.x += p.dx; p.y += p.dy;
        if(p.x < -10 || p.x > innerWidth +10) p.dx *= -1;
        if(p.y < -10 || p.y > innerHeight +10) p.dy *= -1;
      }
      requestAnimationFrame(loop);
    }
    loop();
  })();


  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");

    if (toggle && sidebar) {
        toggle.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            document.body.classList.toggle("menu-open");
        });
    }
});
</script>
</body>
</html>
